---
- hosts: localhost
  gather_facts: yes

  vars:
    my_name: "retronas user config setup"
    system_user_dirs:
      - config
      
    general_options:
      - { option: "title", value: "RetroNAS Packages"}
      - { option: "author", value: "Generated by RetroNAS"}
      - { option: "last_updated", value: "{{ ansible_date_time.date }}"}

    ini_filename: "retronas_packages.ini"

  tasks:
  - name: "{{ my_name }} - Load RetroNAS config"
    include_vars: retronas_vars.yml

  - name: "{{ my_name }} - Create retronas user system dirs"
    file:
      path: "{{ retronas_path }}/{{ item }}"
      owner: "{{ retronas_user }}"
      group: "{{ retronas_group }}"
      state: directory
      mode: "0755"
    with_items: "{{ system_user_dirs }}"

  - name: "{{ my_name }} - Log General Entry"
    ini_file:
      path: "{{ retronas_path }}/config/{{ ini_filename }}"
      section: "general"
      option: "{{ item.option }}"
      value: "{{ item.value }}"
      state: present
    with_items: "{{ general_options }}"
    when: general_options is defined

  - name: "{{ my_name }} - Log Package Entry"
    ini_file:
      path: "{{ retronas_path }}/config/{{ ini_filename }}"
      section: "package"
      option: "{{ module_name }}"
      value: "{{ module_state }}"
      state: "{{ module_state }}"
    when: module_name is defined and 
          module_state is defined

  - name: "{{ my_name }} - fix config perms"
    file:
      path: "{{ retronas_path }}/config/{{ ini_filename }}"
      owner: "{{ retronas_user }}"
      group: "{{ retronas_group }}"
      state: file
      mode: "0644"